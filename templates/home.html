<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tìm chuyến bay</title>
  <link rel="stylesheet" href="/static/style.css">
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
</head>

<body>
  <div class="container">
    <h2>Lên kế hoạch</h2>

    <form id="flightForm" class="flight-form">
      <div class="form-row">
        <div class="form-group">
          <label for="origin" class="form-label">Sân bay phù hợp với bạn <span class="required">*</span></label>
          <div class="input-icon">
            <select id="origin" name="origin" required class="form-control"></select>
            <i class="fa-solid fa-plane-departure icon"></i>
          </div>
        </div>
      </div>

      <div class="form-row double-row">
        <div class="form-group">
          <label for="place" class="form-label">Bạn muốn đến đâu <span class="required">*</span></label>
          <div class="input-icon">
            <select id="place" class="form-control" required>
              <option value="" disabled selected>--Chọn địa điểm--</option>
              <option value="Hà Nội">Hà Nội</option>
              <option value="Hạ Long">Hạ Long</option>
              <option value="Đà Nẵng">Đà Nẵng</option>
              <option value="Sài Gòn">TP.Hồ Chí Minh</option>
              <option value="Nha Trang">Nha Trang</option>
            </select>
            <i class="fa-solid fa-location-dot icon"></i>
          </div>
          <small class="hint">Nhập địa điểm, hệ thống gợi ý sân bay gần đó.</small>
        </div>

        <div class="form-group">
          <label for="destination" class="form-label">Sân bay đến <span class="required">*</span></label>
          <div class="input-icon">
            <select id="destination" name="destination" required class="form-control">
              <option value="">-- Chọn sân bay --</option>
            </select>
            <i class="fa-solid fa-plane-arrival icon"></i>
          </div>
        </div>
      </div>

      <div class="form-row double-row">
        <div class="form-group">
          <label for="date" class="form-label">Thời gian bay (chọn 1 ngày) <span class="required">*</span></label>
          <div class="input-icon">
            <input type="date" id="date" name="departure_date" required class="form-control" />
            <i class="fa-solid fa-calendar-days icon"></i>
          </div>
        </div>

        <div class="form-group">
          <label for="adults" class="form-label">Số lượng người lớn</label>
          <div class="input-icon">
            <input type="number" id="adults" name="adults" min="1" step="1" value="1" class="form-control" />
            <i class="fa-solid fa-user icon"></i>
          </div>
        </div>
      </div>

      <div class="form-row quadruple-row">
        <div class="form-group">
          <label for="hotelType" class="form-label">Loại khách sạn</label>
          <div class="input-icon">
            <select id="hotelType" name="hotelType" class="form-control">
              <option value="">-- Chọn loại khách sạn --</option>
              <option value="1_star">Khách sạn 1 sao</option>
              <option value="2_star">Khách sạn 2 sao</option>
              <option value="3_star">Khách sạn 3 sao</option>
              <option value="4_star">Khách sạn 4 sao</option>
              <option value="5_star">Khách sạn 5 sao</option>
            </select>
            <i class="fa-solid fa-hotel icon"></i>
          </div>
        </div>

        <div class="form-group">
          <label for="rooms" class="form-label">Số phòng</label>
          <div class="input-icon">
            <input type="number" id="rooms" name="rooms" min="1" step="1" value="1" class="form-control" />
            <i class="fa-solid fa-bed icon"></i>
          </div>
        </div>

        <div class="form-group">
          <label for="budget" class="form-label">Ngân sách (VND)</label>
          <div class="input-icon">
            <select id="budget" name="budget" class="form-control">
              <option value="">-- Chọn ngân sách --</option>
              <option value="under_2m">Dưới 2 triệu</option>
              <option value="2m_5m">2 - 5 triệu</option>
              <option value="5m_10m">5 - 10 triệu</option>
              <option value="10m_20m">10 - 20 triệu</option>
              <option value="20m_50m">20 - 50 triệu</option>
              <option value="over_50m">Trên 50 triệu</option>
            </select>
            <i class="fa-solid fa-wallet icon"></i>
          </div>
        </div>

        <div class="form-group form-group-submit">
          <button type="submit" class="btn-submit">Tìm chuyến bay</button>
        </div>
      </div>
    </form>

    <div id="weatherBox" class="weather" style="display:none"></div>
    <div id="outfitBox" class="outfit" style="display:none"></div>
    <div id="forecastBox" class="forecast" style="display:none"></div>
    <div class="result" id="result"></div>
    <div id="sightseeingBox" class="sightseeing" style="display:none"></div>
  </div>

  <script>
    const origins = [
      { code: "HAN", name: "Nội Bài - Hà Nội" },
      { code: "SGN", name: "Tân Sơn Nhất - TP.HCM" },
      { code: "DAD", name: "Đà Nẵng - Đà Nẵng" },
      { code: "CXR", name: "Cam Ranh - Khánh Hòa" },
      { code: "HPH", name: "Cát Bi - Hải Phòng" },
      { code: "VDO", name: "Vân Đồn - Quảng Ninh" },
    ];

    const destinations = {
      "Hạ Long": [
        { code: "VDO", name: "Vân Đồn - Quảng Ninh" },
        { code: "HPH", name: "Cát Bi - Hải Phòng" },
      ],
      "Nha Trang": [
        { code: "CXR", name: "Cam Ranh - Khánh Hòa" },
      ],
      "Hà Nội": [
        { code: "HAN", name: "Nội Bài - Hà Nội" },
      ],
      "Sài Gòn": [
        { code: "SGN", name: "Tân Sơn Nhất - TP.HCM" },
      ],
      "Đà Nẵng": [
        { code: "DAD", name: "Đà Nẵng - Quảng Nam" },
      ],
    };

    const placeToCity = {
      "Hạ Long": "Ha Long",
      "Nha Trang": "Nha Trang",
      "Hà Nội": "Hanoi",
      "Sài Gòn": "Ho Chi Minh City",
      "Đà Nẵng": "Da Nang",
    };

    const originSelect = document.getElementById('origin');
    origins.forEach(o => {
      const opt = document.createElement('option');
      opt.value = o.code;
      opt.textContent = `${o.code}: ${o.name}`;
      originSelect.appendChild(opt);
    });

    const placeInput = document.getElementById('place');
    const destinationSelect = document.getElementById('destination');
    const weatherBox = document.getElementById('weatherBox');
    const outfitBox = document.getElementById('outfitBox');
    const forecastBox = document.getElementById('forecastBox');
    const sightseeingBox = document.getElementById('sightseeingBox');

    function updateDestinations(place) {
      destinationSelect.innerHTML = '<option value="">-- Chọn sân bay --</option>';
      const list = destinations[place?.trim()] || [];
      list.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.code;
        opt.textContent = `${d.code}: ${d.name}`;
        destinationSelect.appendChild(opt);
      });
    }

    placeInput.addEventListener('change', (e) => updateDestinations(e.target.value));
    placeInput.addEventListener('keyup', (e) => updateDestinations(e.target.value));

    function renderForecastDay(day) {
      const rows = day.items.map(it => `
        <tr>
          <td>${it.hour || new Date(it.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
          <td>${it.description || '-'}</td>
          <td>${it.temperature_c ?? '-'}°C</td>
          <td>${it.feels_like_c ?? '-'}°C</td>
          <td>${it.humidity ?? '-'}%</td>
          <td>${it.wind_speed ?? '-'} m/s</td>
        </tr>
      `).join('');
      return `
        <div class="slide" data-date="${day.date}">
          <div class="forecast-header">
            <strong>Dự báo ngày ${day.date}</strong>
          </div>
          <table class="forecast-grid">
            <thead>
              <tr><th>Giờ</th><th>Trạng thái</th><th>Nhiệt độ</th><th>Cảm giác</th><th>Độ ẩm</th><th>Gió</th></tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    function showSlide(idx, slides) {
      slides.forEach((el, i) => {
        el.style.display = i === idx ? 'block' : 'none';
      });
    }

    // Submit form → gọi API backend (weather current + outfit + forecast + flights)
    const form = document.getElementById('flightForm');
    const resultDiv = document.getElementById('result');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const origin = originSelect.value;
      const destination = destinationSelect.value;
      const departure_date = document.getElementById('date').value;
      let adultsVal = document.getElementById('adults').value;
      const adults = Math.max(1, parseInt(adultsVal, 10) || 1);
      const place = (document.getElementById('place').value || '').trim();
      const city = placeToCity[place] || place;
      const hotelType = document.getElementById('hotelType').value || '';
      const budget = document.getElementById('budget').value || '';

      if (!origin || !destination || !departure_date) {
        alert('Vui lòng điền đầy đủ các trường bắt buộc');
        return;
      }

      // Weather + Outfit + Forecast
      try {
        weatherBox.style.display = 'none';
        weatherBox.innerHTML = '';
        outfitBox.style.display = 'none';
        outfitBox.innerHTML = '';
        forecastBox.style.display = 'none';
        forecastBox.innerHTML = '';
        sightseeingBox.style.display = 'none';
        sightseeingBox.innerHTML = '';

        const [wr, orq, fr] = await Promise.all([
          fetch(`/weather/by-city?city=${encodeURIComponent(city)}`),
          fetch(`/weather/outfit-by-date?city=${encodeURIComponent(city)}&date=${departure_date}`),
          fetch(`/weather/forecast-by-city?city=${encodeURIComponent(city)}`)
        ]);

        if (wr.ok) {
          const w = await wr.json();
          if (w && !w.message) {
            // Gán icon thời tiết dựa theo mô tả
            let weatherIcon = '☁️'; // mặc định mây
            const desc = (w.description || '').toLowerCase();
            if (desc.includes('nắng') || desc.includes('clear')) weatherIcon = '☀️';
            else if (desc.includes('mưa')) weatherIcon = '🌧️';
            else if (desc.includes('bão') || desc.includes('dông')) weatherIcon = '⛈️';
            else if (desc.includes('tuyết')) weatherIcon = '❄️';

            weatherBox.innerHTML = `
              <div><strong><span style="font-size:28px; margin-right:8px;">${weatherIcon}</span>Thời tiết hiện tại</strong> - ${w.city || ''}</div>
              <div style="font-size:22px; margin-top:6px;">
                Nhiệt độ: <span style="font-weight:700; color:#d9534f;">${w.temperature_c ?? '-'}°C</span>, 
                Cảm giác: <span style="font-weight:700; color:#f0ad4e;">${w.feels_like_c ?? '-'}°C</span>
              </div>
              <div style="margin-top:8px; font-style:italic; color:#5a5a5a;">
                <i class="fas fa-cloud" style="color:#6c757d; margin-right:6px;"></i> ${w.description || '-'} | 
                <i class="fas fa-tint" style="color:#3498db; margin: 0 6px;"></i> Độ ẩm: ${w.humidity ?? '-'}% | 
                <i class="fas fa-wind" style="color:#85c1e9; margin-left:6px;"></i> Gió: ${w.wind_speed ?? '-'} m/s
              </div>
            `;
            weatherBox.style.display = 'block';
          }
        }

        if (orq.ok) {
          const outfitData = await orq.json();
          if (outfitData && outfitData.outfit && !outfitData.message) {
            const o = outfitData.outfit;
            outfitBox.innerHTML = `
              <div><strong><i class="fas fa-tshirt" style="color:#5cb85c; margin-right:6px;"></i>Gợi ý trang phục cho ngày ${departure_date}</strong></div>
              <div style="margin-top:6px;">${(o.outfit || []).map(x => `<span class='tag'>${x}</span>`).join(' ')}</div>
              ${o.outerwear ? `<div class='small' style="margin-top:6px;"><i class="fas fa-jacket" style="color:#f0ad4e; margin-right:6px;"></i>Áo khoác: ${o.outerwear}</div>` : ''}
              <div class='small' style="margin-top:6px;"><i class="fas fa-shoe-prints" style="color:#d9534f; margin-right:6px;"></i>Giày: ${o.footwear || '-'}</div>
              ${o.accessories?.length ? `<div class='small' style="margin-top:6px;">Phụ kiện: ${(o.accessories || []).join(', ')}</div>` : ''}
              ${o.colors?.length ? `<div class='small' style="margin-top:6px;">Màu sắc: ${(o.colors || []).join(', ')}</div>` : ''}
              ${o.comfort_level ? `<div class='small' style="margin-top:6px;">Độ thoải mái: ${o.comfort_level}</div>` : ''}
              ${o.notes ? `<div class='small' style="margin-top:6px;">Lưu ý: ${o.notes}</div>` : ''}
              <div class='small' style="margin-top:6px;">Thời gian: ${outfitData.sample_time || ''} - ${outfitData.weather_note || ''}</div>
            `;
            outfitBox.style.display = 'block';
          } else {
            outfitBox.innerHTML = `<div>Không có dữ liệu trang phục cho ngày ${departure_date}</div>`;
            outfitBox.style.display = 'block';
          }
        }

        if (fr.ok) {
          const f = await fr.json();
          if (f && Array.isArray(f.days) && f.days.length) {
            const slidesHtml = f.days.map(renderForecastDay).join('');
            forecastBox.innerHTML = `
              <div class="forecast-header">
                <strong>Dự báo 5 ngày tới - ${f.city || ''}</strong>
                <div>
                  <button id="prevDay" class="nav-btn">&#8249;</button>
                  <button id="nextDay" class="nav-btn">&#8250;</button>
                </div>
              </div>
              <div id="slides">${slidesHtml}</div>
            `;
            forecastBox.style.display = 'block';
            const slides = Array.from(document.querySelectorAll('#slides .slide'));
            let index = 0;
            showSlide(index, slides);
            document.getElementById('prevDay').onclick = () => { index = Math.max(0, index - 1); showSlide(index, slides); };
            document.getElementById('nextDay').ondblclick = () => { index = Math.min(slides.length - 1, index + 1); showSlide(index, slides); };
            document.getElementById('nextDay').onclick = (e) => e.preventDefault();
          }
        }
        // Sightseeing (địa điểm du lịch, không chi phí)
        try {
                const placeV = (placeInput.value || '').trim();
                let cityForAp = placeV|| 'Hà Nội';
                if (cityForAp.toLowerCase() === 'sài gòn' || cityForAp.toLowerCase() === 'saigon') {
                      cityForAp = 'Hồ Chí Minh';
                }
          const sr = await fetch(`/sightseeing/no-cost-sightseeing?city=${encodeURIComponent(cityForAp)}`);
          if (sr.ok) {
            const ss = await sr.json();
            if (Array.isArray(ss) && ss.length) {
              const cards = ss.map(s => `
                <div class="cards-container">
                  <div class="s-title">${s.name || '-'}</div>
                  <div class="s-info">
                    <div>Địa chỉ: ${s.address || '-'}</div>
                    ${s.open_close ? `<div>Giờ mở cửa: ${s.open_close}</div>` : ''}
                    ${s.type ? `<div>Loại: ${s.type}</div>` : ''}
                    ${s.price ? `<div>Giá tham khảo: ${s.price}</div>` : ''}
                    ${s.describe ? `<div class="s-desc">${s.describe}</div>` : ''}
                  </div>
                </div>
              `).join('');
              sightseeingBox.innerHTML = `
                <div class='section-header'><strong>Địa điểm du lịch gợi ý</strong> - ${place}</div>
                <div class='sightseeing-grid'>${cards}</div>
              `;
              sightseeingBox.style.display = 'block';
            }
          }
        } catch {}
      } catch { }

      // Flights
      let url = `/flights/search-flights?origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&departure_date=${encodeURIComponent(departure_date)}&adults=${encodeURIComponent(adults)}`;

      // Thêm thông tin khách sạn và ngân sách nếu có
      if (hotelType) {
        url += `&hotel_type=${encodeURIComponent(hotelType)}`;
      }
      if (budget) {
        url += `&budget=${encodeURIComponent(budget)}`;
      }
      resultDiv.innerHTML = 'Đang tìm kiếm...';
      try {
        const res = await fetch(url, { headers: { 'accept': 'application/json' } });
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || `HTTP ${res.status}`);
        }
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          resultDiv.innerHTML = 'Không tìm thấy chuyến bay phù hợp';
          return;
        }
        resultDiv.innerHTML = data.map((item, idx) => renderFlight(item, idx)).join('');
      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = 'Có lỗi xảy ra khi tìm kiếm';
      }
    });

    function renderFlight(item, index) {
      // Format giá VND với dấu phẩy phân cách hàng nghìn
      const price = `${item.price.toLocaleString('vi-VN')} ${item.currency}`;

      // Hiển thị tất cả các tuyến bay
      const segments = item.segments || [];
      let segmentsHtml = '';

      if (segments.length === 0) {
        segmentsHtml = '<div class="small">Không có thông tin tuyến bay</div>';
      } else if (segments.length === 1) {
        // Chuyến bay trực tiếp
        const seg = segments[0];
        segmentsHtml = `
          <div><strong>${seg.departure_iata}</strong> → <strong>${seg.arrival_iata}</strong> | ${seg.carrier_code} ${seg.flight_number}</div>
          <div class="small">${seg.departure_time} → ${seg.arrival_time} | Thời lượng: ${seg.duration}</div>
        `;
      } else {
        // Chuyến bay có chuyển máy bay
        const firstSeg = segments[0];
        const lastSeg = segments[segments.length - 1];
        segmentsHtml = `
          <div><strong>${firstSeg.departure_iata}</strong> → <strong>${lastSeg.arrival_iata}</strong> (${segments.length} tuyến - có chuyển máy bay)</div>
        `;

        // Hiển thị chi tiết từng tuyến
        segments.forEach((seg, index) => {
          segmentsHtml += `
            <div class="small">
              Tuyến ${index + 1}: <strong>${seg.departure_iata}</strong> → <strong>${seg.arrival_iata}</strong> | ${seg.carrier_code} ${seg.flight_number}
              <br>&nbsp;&nbsp;&nbsp;&nbsp;${seg.departure_time} → ${seg.arrival_time} | Thời lượng: ${seg.duration}
            </div>
          `;
        });
      }

      return `
        <div class="card" data-flight-index="${index}">
          ${segmentsHtml}
          <div>Giá: <strong>${price}</strong> | Ghế còn: ${item.seats_left ?? '-'}</div>
          <div style="margin-top:8px;">
            <button class="show-hotels" data-index="${index}" data-price="${item.price}">Xem khách sạn phù hợp</button>
          </div>
          <div id="hotels-for-${index}" style="margin-top:10px;"></div>
        </div>
      `;
    }

    // Chuyển giá trị ngân sách dropdown thành khoảng tiền [min, max]
    function getBudgetRange(budgetVal) {
      switch (budgetVal) {
        case 'under_2m': return [0, 2_000_000];
        case '2m_5m': return [2_000_000, 5_000_000];
        case '5m_10m': return [5_000_000, 10_000_000];
        case '10m_20m': return [10_000_000, 20_000_000];
        case '20m_50m': return [20_000_000, 50_000_000];
        case 'over_50m': return [50_000_000, Number.POSITIVE_INFINITY];
        default: return [0, Number.POSITIVE_INFINITY];
      }
    }

    // Parse giá khách sạn từ price_point (có thể là số hoặc chuỗi)
    function parseHotelPrice(pricePoint) {
      if (pricePoint == null) return NaN;
      if (typeof pricePoint === 'number') return pricePoint;
      if (typeof pricePoint === 'string') {
        const digits = pricePoint.replace(/[^0-9]/g, '');
        if (!digits) return NaN;
        try { return parseInt(digits, 10); } catch { return NaN; }
      }
      return NaN;
    }

    // Lắng nghe click để hiển thị khách sạn theo từng chuyến bay và ngân sách còn lại
    resultDiv.addEventListener('click', async (e) => {
      const btn = e.target.closest('.show-hotels');
      if (!btn) return;

      // Lấy dữ liệu cần thiết
      const idx = btn.getAttribute('data-index');
      const flightPrice = parseInt(btn.getAttribute('data-price'), 10) || 0;
      const hotelsContainer = document.getElementById(`hotels-for-${idx}`);
      const hotelTypeVal = document.getElementById('hotelType').value || '';
      const budgetVal = document.getElementById('budget').value || '';
      const rooms = Math.max(1, parseInt((document.getElementById('rooms').value || '1'), 10));

      // Lấy city tiếng Việt từ input địa điểm
      const placeVal = (placeInput.value || '').trim();
      const cityForApi = placeVal || 'Hà Nội';

      // Trường hợp KHÔNG nhập ngân sách: hiển thị theo đánh giá
      if (!budgetVal) {
        let selectedStars = NaN;
        if (hotelTypeVal) {
          selectedStars = parseInt(String(hotelTypeVal).replace(/\D/g, ''), 10);
        }
        let hotelApiUrl;
        if (!Number.isNaN(selectedStars)) {
          hotelApiUrl = `/hotel/top-hotel-star?city=${encodeURIComponent(cityForApi)}&stars=${encodeURIComponent(selectedStars)}`;
        } else {
          hotelApiUrl = `/hotel/top-hotel-rating?city=${encodeURIComponent(cityForApi)}`;
        }
        hotelsContainer.innerHTML = 'Đang tải dữ liệu khách sạn...';
        try {
          const hotelResp = await fetch(hotelApiUrl);
          if (!hotelResp.ok) throw new Error('Lỗi khi lấy dữ liệu khách sạn');
          const hotels = await hotelResp.json();
          if (!hotels.length) {
            hotelsContainer.innerHTML = '<div class="small">Không có khách sạn nào phù hợp.</div>';
            return;
          }
          // Sắp xếp hiển thị theo đánh giá (phòng trường hợp backend chưa sort)
          if (!Number.isNaN(selectedStars)) {
            hotels.sort((a, b) => (b.weighted_rating ?? b.rating ?? 0) - (a.weighted_rating ?? a.rating ?? 0));
          } else {
            hotels.sort((a, b) => (b.rating ?? b.weighted_rating ?? 0) - (a.rating ?? a.weighted_rating ?? 0));
          }
          hotelsContainer.innerHTML = hotels.map(h => {
             // Xử lý utilities nếu là mảng
            const utilitiesHtml = Array.isArray(h.utilities) && h.utilities.length > 0
            ? `<div class="hotel-utilities">
                ${h.utilities.map(u => `<span class="utility-tag">${u}</span>`).join(' ')}
              </div>`
            : '';

            const priceFormatted = Number.isFinite(parseHotelPrice(h.price_point))
            ? parseHotelPrice(h.price_point).toLocaleString('vi-VN') + ' VND'
            : '-';

            return `
              <div class="hotel-card">
                <div class="hotel-image-wrapper">
                  <a href="${h.link || '#'}" target="_blank" rel="noopener noreferrer" title="${h.name}">
                    <img src="${h.image || 'https://via.placeholder.com/300x180?text=No+Image'}" alt="${h.name}" class="hotel-image" />
                  </a>
                </div>
                <div class="hotel-info">
                  <h4><a href="${h.link || '#'}" target="_blank" rel="noopener noreferrer">${h.name}</a></h4>
                  <p class="hotel-address">${h.address || ''}</p>
                  <p class="hotel-stars">⭐ ${'★'.repeat(h.stars || 0)}${'☆'.repeat(5 - (h.stars || 0))}</p>
                  <p>Điểm đánh giá: <strong>${h.rating ?? '-'}</strong> (${h.review_count ?? 0} đánh giá)</p>
                  <p>Giá mỗi phòng: <strong>${priceFormatted}</strong></p>
                </div>
              </div>
            `;
          }).join('');
        } catch (err) {
          console.error(err);
          hotelsContainer.innerHTML = '<div class="small">Lỗi khi tải dữ liệu khách sạn</div>';
        }
        return;
      }

      const [budgetMin, budgetMax] = getBudgetRange(budgetVal);

      // Ngân sách tổng cho cả chuyến đi (không nhân theo số người)
      const remainingBudget = (budgetMax || 0) - flightPrice;
      if (remainingBudget <= 0) {
        hotelsContainer.innerHTML = '<div class="small">Ngân sách không đủ sau khi trừ tiền vé máy bay.</div>';
        return;
      }

      // Giới hạn tối đa cho mỗi phòng để backend lọc sơ bộ
      const perRoomMax = Math.floor(remainingBudget / rooms);

      // Xác định endpoint theo việc có chọn loại khách sạn hay không
      let hotelApiUrl;
      let selectedStars = NaN;
      if (hotelTypeVal) {
        selectedStars = parseInt(String(hotelTypeVal).replace(/\D/g, ''), 10);
      }
      const priceParams = `&max_price=${encodeURIComponent(perRoomMax)}`;
      if (!Number.isNaN(selectedStars)) {
        hotelApiUrl = `/hotel/top-hotel-star?city=${encodeURIComponent(cityForApi)}&stars=${encodeURIComponent(selectedStars)}${priceParams}`;
      } else {
        hotelApiUrl = `/hotel/top-hotel-rating?city=${encodeURIComponent(cityForApi)}${priceParams}`;
      }

      hotelsContainer.innerHTML = 'Đang tải dữ liệu khách sạn...';

      try {
        const hotelResp = await fetch(hotelApiUrl);
        if (!hotelResp.ok) throw new Error('Lỗi khi lấy dữ liệu khách sạn');
        const hotels = await hotelResp.json();

        // Lọc cuối cùng theo tổng chi phí khách sạn = giá mỗi phòng * số phòng <= remainingBudget
        const filtered = hotels.filter(h => {
          const hp = parseHotelPrice(h.price_point);
          if (!Number.isFinite(hp)) return false;
          return (hp * rooms) <= remainingBudget;
        });

        // Sắp xếp theo yêu cầu
        if (!Number.isNaN(selectedStars)) {
          filtered.sort((a, b) => (b.weighted_rating ?? b.rating ?? 0) - (a.weighted_rating ?? a.rating ?? 0));
        } else {
          filtered.sort((a, b) => (b.rating ?? b.weighted_rating ?? 0) - (a.rating ?? a.weighted_rating ?? 0));
        }

        if (!filtered.length) {
          hotelsContainer.innerHTML = '<div class="small">Không có khách sạn nào phù hợp với ngân sách còn lại.</div>';
          return;
        }

                 // Render danh sách khách sạn
        hotelsContainer.innerHTML = filtered.map(h => {
           // Xử lý utilities nếu là mảng
          const utilitiesHtml = Array.isArray(h.utilities) && h.utilities.length > 0
          ? `<div class="hotel-utilities">
              ${h.utilities.map(u => `<span class="utility-tag">${u}</span>`).join(' ')}
            </div>`
          : '';

          const priceFormatted = Number.isFinite(parseHotelPrice(h.price_point))
          ? parseHotelPrice(h.price_point).toLocaleString('vi-VN') + ' VND'
          : '-';

          return `
            <div class="hotel-card">
              <div class="hotel-image-wrapper">
                <a href="${h.link || '#'}" target="_blank" rel="noopener noreferrer" title="${h.name}">
                  <img src="${h.image || 'https://via.placeholder.com/300x180?text=No+Image'}" alt="${h.name}" class="hotel-image" />
                </a>
              </div>
              <div class="hotel-info">
                <h4><a href="${h.link || '#'}" target="_blank" rel="noopener noreferrer">${h.name}</a></h4>
                <p class="hotel-address">${h.address || ''}</p>
                <p class="hotel-stars">⭐ ${'★'.repeat(h.stars || 0)}${'☆'.repeat(5 - (h.stars || 0))}</p>
                <p>Điểm đánh giá: <strong>${h.rating ?? '-'}</strong> (${h.review_count ?? 0} đánh giá)</p>
                <p>Giá mỗi phòng: <strong>${priceFormatted}</strong></p>
                <p class="small">Tổng (ước tính) cho ${rooms} phòng: <strong>${(() => { 
                  const p = parseHotelPrice(h.price_point);
                  return Number.isFinite(p) ? (p * rooms).toLocaleString('vi-VN') + ' VND' : '-'; 
                })()}</strong></p>
                ${utilitiesHtml}
                <button class="show-sightseeing" data-flight-price="${flightPrice}" data-hotel-price="${(() => { const p=parseHotelPrice(h.price_point); return Number.isFinite(p)? p*rooms : '';})()}">Xem địa điểm giải trí phù hợp</button>
              </div>
            </div>
          `;
        }).join('');

         // Lắng nghe click để hiển thị địa điểm du lịch theo ngân sách còn lại
         hotelsContainer.addEventListener('click', async (e) => {
           const btn = e.target.closest('.show-sightseeing');
           if (!btn) return;

           const flightPrice = parseInt(btn.getAttribute('data-flight-price'), 10) || 0;
           const hotelTotal = parseInt(btn.getAttribute('data-hotel-price'), 10) || 0;

           const budgetVal = document.getElementById('budget').value || '';
           if (!budgetVal) {
             sightseeingBox.innerHTML = '<div class="small">Vui lòng chọn ngân sách trước.</div>';
             sightseeingBox.style.display = 'block';
             return;
           }
           const [ , budgetMax ] = getBudgetRange(budgetVal);

           // City tiếng Việt
           const placeVal = (placeInput.value || '').trim();
           const cityForApi = placeVal || 'Hà Nội';

           // Ngân sách còn lại sau vé và khách sạn
           const remaining = (budgetMax || 0) - flightPrice - hotelTotal;
           if (remaining <= 0) {
             sightseeingBox.innerHTML = '<div class="small">Ngân sách không đủ sau khi trừ tiền vé máy bay và khách sạn.</div>';
             sightseeingBox.style.display = 'block';
             return;
           }

           // Tải danh sách địa điểm du lịch và lọc theo approximate_price <= remaining
           sightseeingBox.innerHTML = 'Đang tải địa điểm du lịch...';
           sightseeingBox.style.display = 'block';
           try {
              const placeV = (placeInput.value || '').trim();
              let cityForAp = placeV|| 'Hà Nội';
              if (cityForAp.toLowerCase() === 'sài gòn' || cityForAp.toLowerCase() === 'saigon') {
                    cityForAp = 'Hồ Chí Minh';
              }
             const sr = await fetch(`/sightseeing/no-cost-sightseeing?city=${encodeURIComponent(cityForAp)}`);
             if (!sr.ok) throw new Error('Sightseeing fetch error');
             const ss = await sr.json();
             const filtered = (Array.isArray(ss) ? ss : []).filter(s => {
               if (typeof s.approximate_price === 'number') {
                 return s.approximate_price <= remaining;
               }
               // Nếu không có giá ước lượng, vẫn hiển thị như gợi ý miễn phí/không rõ giá
               return true;
             });

             if (!filtered.length) {
               sightseeingBox.innerHTML = '<div class="small">Không có địa điểm giải trí phù hợp với ngân sách còn lại.</div>';
               return;
             }

             const cards = filtered.map(s => `
              <div class="cards-container">
                <div class="s-title">${s.name || '-'}</div>
                <div class="s-info">
                  <div>Địa chỉ: ${s.address || '-'}</div>
                  ${s.open_close ? `<div>Giờ mở cửa: ${s.open_close}</div>` : ''}
                  ${s.type ? `<div>Loại: ${s.type}</div>` : ''}
                  ${s.price ? `<div>Giá tham khảo: ${s.price}</div>` : ''}
                  ${s.describe ? `<div class="s-desc">${s.describe}</div>` : ''}
                </div>
              </div>
             `).join('');

             sightseeingBox.innerHTML = `
               <div class='section-header'>
                 <strong>Địa điểm du lịch gợi ý</strong> - ${cityForAp}
                 <div class='small'>Chi phí hiện tại: ${flightPrice.toLocaleString('vi-VN')} VND (vé máy bay) + ${hotelTotal.toLocaleString('vi-VN')} VND (khách sạn)</div>
                 <div class='small'>Ngân sách còn lại: ${remaining.toLocaleString('vi-VN')} VND</div>
               </div>
               <div class='sightseeing-grid'>${cards}</div>
             `;
           } catch (err) {
             console.error(err);
             sightseeingBox.innerHTML = '<div class="small">Lỗi khi tải địa điểm du lịch</div>';
           }
         });
      } catch (err) {
        console.error(err);
        hotelsContainer.innerHTML = '<div class="small">Lỗi khi tải dữ liệu khách sạn</div>';
      }
    });
  </script>
</body>

</html>