<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>T√¨m chuy·∫øn bay</title>
  <link rel="stylesheet" href="/static/style.css">
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
</head>

<body>
  <div class="container">
    <h2>L√™n k·∫ø ho·∫°ch</h2>

    <form id="flightForm" class="flight-form">
      <div class="form-row">
        <div class="form-group">
          <label for="origin" class="form-label">S√¢n bay ph√π h·ª£p v·ªõi b·∫°n <span class="required">*</span></label>
          <div class="input-icon">
            <select id="origin" name="origin" required class="form-control"></select>
            <i class="fa-solid fa-plane-departure icon"></i>
          </div>
        </div>
      </div>

      <div class="form-row double-row">
        <div class="form-group">
          <label for="place" class="form-label">B·∫°n mu·ªën ƒë·∫øn ƒë√¢u <span class="required">*</span></label>
          <div class="input-icon">
            <select id="place" class="form-control" required>
              <option value="" disabled selected>--Ch·ªçn ƒë·ªãa ƒëi·ªÉm--</option>
              <option value="H√† N·ªôi">H√† N·ªôi</option>
              <option value="H·∫° Long">H·∫° Long</option>
              <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
              <option value="S√†i G√≤n">TP.H·ªì Ch√≠ Minh</option>
              <option value="Nha Trang">Nha Trang</option>
            </select>
            <i class="fa-solid fa-location-dot icon"></i>
          </div>
          <small class="hint">Nh·∫≠p ƒë·ªãa ƒëi·ªÉm, h·ªá th·ªëng g·ª£i √Ω s√¢n bay g·∫ßn ƒë√≥.</small>
        </div>

        <div class="form-group">
          <label for="destination" class="form-label">S√¢n bay ƒë·∫øn <span class="required">*</span></label>
          <div class="input-icon">
            <select id="destination" name="destination" required class="form-control">
              <option value="">-- Ch·ªçn s√¢n bay --</option>
            </select>
            <i class="fa-solid fa-plane-arrival icon"></i>
          </div>
        </div>
      </div>

      <div class="form-row double-row">
        <div class="form-group">
          <label for="date" class="form-label">Th·ªùi gian bay (ch·ªçn 1 ng√†y) <span class="required">*</span></label>
          <div class="input-icon">
            <input type="date" id="date" name="departure_date" required class="form-control" />
            <i class="fa-solid fa-calendar-days icon"></i>
          </div>
        </div>

        <div class="form-group">
          <label for="adults" class="form-label">S·ªë l∆∞·ª£ng ng∆∞·ªùi l·ªõn</label>
          <div class="input-icon">
            <input type="number" id="adults" name="adults" min="1" step="1" value="1" class="form-control" />
            <i class="fa-solid fa-user icon"></i>
          </div>
        </div>
      </div>

      <div class="form-row quadruple-row">
        <div class="form-group">
          <label for="hotelType" class="form-label">Lo·∫°i kh√°ch s·∫°n</label>
          <div class="input-icon">
            <select id="hotelType" name="hotelType" class="form-control">
              <option value="">-- Ch·ªçn lo·∫°i kh√°ch s·∫°n --</option>
              <option value="1_star">Kh√°ch s·∫°n 1 sao</option>
              <option value="2_star">Kh√°ch s·∫°n 2 sao</option>
              <option value="3_star">Kh√°ch s·∫°n 3 sao</option>
              <option value="4_star">Kh√°ch s·∫°n 4 sao</option>
              <option value="5_star">Kh√°ch s·∫°n 5 sao</option>
            </select>
            <i class="fa-solid fa-hotel icon"></i>
          </div>
        </div>

        <div class="form-group">
          <label for="rooms" class="form-label">S·ªë ph√≤ng</label>
          <div class="input-icon">
            <input type="number" id="rooms" name="rooms" min="1" step="1" value="1" class="form-control" />
            <i class="fa-solid fa-bed icon"></i>
          </div>
        </div>

        <div class="form-group">
          <label for="budget" class="form-label">Ng√¢n s√°ch (VND)</label>
          <div class="input-icon">
            <select id="budget" name="budget" class="form-control">
              <option value="">-- Ch·ªçn ng√¢n s√°ch --</option>
              <option value="under_2m">D∆∞·ªõi 2 tri·ªáu</option>
              <option value="2m_5m">2 - 5 tri·ªáu</option>
              <option value="5m_10m">5 - 10 tri·ªáu</option>
              <option value="10m_20m">10 - 20 tri·ªáu</option>
              <option value="20m_50m">20 - 50 tri·ªáu</option>
              <option value="over_50m">Tr√™n 50 tri·ªáu</option>
            </select>
            <i class="fa-solid fa-wallet icon"></i>
          </div>
        </div>

        <div class="form-group form-group-submit">
          <button type="submit" class="btn-submit">T√¨m chuy·∫øn bay</button>
        </div>
      </div>
    </form>

    <div id="weatherBox" class="weather" style="display:none"></div>
    <div id="outfitBox" class="outfit" style="display:none"></div>
    <div id="forecastBox" class="forecast" style="display:none"></div>
    <div class="result" id="result"></div>
    <div id="sightseeingBox" class="sightseeing" style="display:none"></div>
  </div>

  <script>
    const origins = [
      { code: "HAN", name: "N·ªôi B√†i - H√† N·ªôi" },
      { code: "SGN", name: "T√¢n S∆°n Nh·∫•t - TP.HCM" },
      { code: "DAD", name: "ƒê√† N·∫µng - ƒê√† N·∫µng" },
      { code: "CXR", name: "Cam Ranh - Kh√°nh H√≤a" },
      { code: "HPH", name: "C√°t Bi - H·∫£i Ph√≤ng" },
      { code: "VDO", name: "V√¢n ƒê·ªìn - Qu·∫£ng Ninh" },
    ];

    const destinations = {
      "H·∫° Long": [
        { code: "VDO", name: "V√¢n ƒê·ªìn - Qu·∫£ng Ninh" },
        { code: "HPH", name: "C√°t Bi - H·∫£i Ph√≤ng" },
      ],
      "Nha Trang": [
        { code: "CXR", name: "Cam Ranh - Kh√°nh H√≤a" },
      ],
      "H√† N·ªôi": [
        { code: "HAN", name: "N·ªôi B√†i - H√† N·ªôi" },
      ],
      "S√†i G√≤n": [
        { code: "SGN", name: "T√¢n S∆°n Nh·∫•t - TP.HCM" },
      ],
      "ƒê√† N·∫µng": [
        { code: "DAD", name: "ƒê√† N·∫µng - Qu·∫£ng Nam" },
      ],
    };

    const placeToCity = {
      "H·∫° Long": "Ha Long",
      "Nha Trang": "Nha Trang",
      "H√† N·ªôi": "Hanoi",
      "S√†i G√≤n": "Ho Chi Minh City",
      "ƒê√† N·∫µng": "Da Nang",
    };

    const originSelect = document.getElementById('origin');
    origins.forEach(o => {
      const opt = document.createElement('option');
      opt.value = o.code;
      opt.textContent = `${o.code}: ${o.name}`;
      originSelect.appendChild(opt);
    });

    const placeInput = document.getElementById('place');
    const destinationSelect = document.getElementById('destination');
    const weatherBox = document.getElementById('weatherBox');
    const outfitBox = document.getElementById('outfitBox');
    const forecastBox = document.getElementById('forecastBox');
    const sightseeingBox = document.getElementById('sightseeingBox');

    function updateDestinations(place) {
      destinationSelect.innerHTML = '<option value="">-- Ch·ªçn s√¢n bay --</option>';
      const list = destinations[place?.trim()] || [];
      list.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.code;
        opt.textContent = `${d.code}: ${d.name}`;
        destinationSelect.appendChild(opt);
      });
    }

    placeInput.addEventListener('change', (e) => updateDestinations(e.target.value));
    placeInput.addEventListener('keyup', (e) => updateDestinations(e.target.value));

    function renderForecastDay(day) {
      const rows = day.items.map(it => `
        <tr>
          <td>${it.hour || new Date(it.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
          <td>${it.description || '-'}</td>
          <td>${it.temperature_c ?? '-'}¬∞C</td>
          <td>${it.feels_like_c ?? '-'}¬∞C</td>
          <td>${it.humidity ?? '-'}%</td>
          <td>${it.wind_speed ?? '-'} m/s</td>
        </tr>
      `).join('');
      return `
        <div class="slide" data-date="${day.date}">
          <div class="forecast-header">
            <strong>D·ª± b√°o ng√†y ${day.date}</strong>
          </div>
          <table class="forecast-grid">
            <thead>
              <tr><th>Gi·ªù</th><th>Tr·∫°ng th√°i</th><th>Nhi·ªát ƒë·ªô</th><th>C·∫£m gi√°c</th><th>ƒê·ªô ·∫©m</th><th>Gi√≥</th></tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    function showSlide(idx, slides) {
      slides.forEach((el, i) => {
        el.style.display = i === idx ? 'block' : 'none';
      });
    }

    // Submit form ‚Üí g·ªçi API backend (weather current + outfit + forecast + flights)
    const form = document.getElementById('flightForm');
    const resultDiv = document.getElementById('result');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const origin = originSelect.value;
      const destination = destinationSelect.value;
      const departure_date = document.getElementById('date').value;
      let adultsVal = document.getElementById('adults').value;
      const adults = Math.max(1, parseInt(adultsVal, 10) || 1);
      const place = (document.getElementById('place').value || '').trim();
      const city = placeToCity[place] || place;
      const hotelType = document.getElementById('hotelType').value || '';
      const budget = document.getElementById('budget').value || '';

      if (!origin || !destination || !departure_date) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc');
        return;
      }

      // Weather + Outfit + Forecast
      try {
        weatherBox.style.display = 'none';
        weatherBox.innerHTML = '';
        outfitBox.style.display = 'none';
        outfitBox.innerHTML = '';
        forecastBox.style.display = 'none';
        forecastBox.innerHTML = '';
        sightseeingBox.style.display = 'none';
        sightseeingBox.innerHTML = '';

        const [wr, orq, fr] = await Promise.all([
          fetch(`/weather/by-city?city=${encodeURIComponent(city)}`),
          fetch(`/weather/outfit-by-date?city=${encodeURIComponent(city)}&date=${departure_date}`),
          fetch(`/weather/forecast-by-city?city=${encodeURIComponent(city)}`)
        ]);

        if (wr.ok) {
          const w = await wr.json();
          if (w && !w.message) {
            // G√°n icon th·ªùi ti·∫øt d·ª±a theo m√¥ t·∫£
            let weatherIcon = '‚òÅÔ∏è'; // m·∫∑c ƒë·ªãnh m√¢y
            const desc = (w.description || '').toLowerCase();
            if (desc.includes('n·∫Øng') || desc.includes('clear')) weatherIcon = '‚òÄÔ∏è';
            else if (desc.includes('m∆∞a')) weatherIcon = 'üåßÔ∏è';
            else if (desc.includes('b√£o') || desc.includes('d√¥ng')) weatherIcon = '‚õàÔ∏è';
            else if (desc.includes('tuy·∫øt')) weatherIcon = '‚ùÑÔ∏è';

            weatherBox.innerHTML = `
              <div><strong><span style="font-size:28px; margin-right:8px;">${weatherIcon}</span>Th·ªùi ti·∫øt hi·ªán t·∫°i</strong> - ${w.city || ''}</div>
              <div style="font-size:22px; margin-top:6px;">
                Nhi·ªát ƒë·ªô: <span style="font-weight:700; color:#d9534f;">${w.temperature_c ?? '-'}¬∞C</span>, 
                C·∫£m gi√°c: <span style="font-weight:700; color:#f0ad4e;">${w.feels_like_c ?? '-'}¬∞C</span>
              </div>
              <div style="margin-top:8px; font-style:italic; color:#5a5a5a;">
                <i class="fas fa-cloud" style="color:#6c757d; margin-right:6px;"></i> ${w.description || '-'} | 
                <i class="fas fa-tint" style="color:#3498db; margin: 0 6px;"></i> ƒê·ªô ·∫©m: ${w.humidity ?? '-'}% | 
                <i class="fas fa-wind" style="color:#85c1e9; margin-left:6px;"></i> Gi√≥: ${w.wind_speed ?? '-'} m/s
              </div>
            `;
            weatherBox.style.display = 'block';
          }
        }

        if (orq.ok) {
          const outfitData = await orq.json();
          if (outfitData && outfitData.outfit && !outfitData.message) {
            const o = outfitData.outfit;
            outfitBox.innerHTML = `
              <div><strong><i class="fas fa-tshirt" style="color:#5cb85c; margin-right:6px;"></i>G·ª£i √Ω trang ph·ª•c cho ng√†y ${departure_date}</strong></div>
              <div style="margin-top:6px;">${(o.outfit || []).map(x => `<span class='tag'>${x}</span>`).join(' ')}</div>
              ${o.outerwear ? `<div class='small' style="margin-top:6px;"><i class="fas fa-jacket" style="color:#f0ad4e; margin-right:6px;"></i>√Åo kho√°c: ${o.outerwear}</div>` : ''}
              <div class='small' style="margin-top:6px;"><i class="fas fa-shoe-prints" style="color:#d9534f; margin-right:6px;"></i>Gi√†y: ${o.footwear || '-'}</div>
              ${o.accessories?.length ? `<div class='small' style="margin-top:6px;">Ph·ª• ki·ªán: ${(o.accessories || []).join(', ')}</div>` : ''}
              ${o.colors?.length ? `<div class='small' style="margin-top:6px;">M√†u s·∫Øc: ${(o.colors || []).join(', ')}</div>` : ''}
              ${o.comfort_level ? `<div class='small' style="margin-top:6px;">ƒê·ªô tho·∫£i m√°i: ${o.comfort_level}</div>` : ''}
              ${o.notes ? `<div class='small' style="margin-top:6px;">L∆∞u √Ω: ${o.notes}</div>` : ''}
              <div class='small' style="margin-top:6px;">Th·ªùi gian: ${outfitData.sample_time || ''} - ${outfitData.weather_note || ''}</div>
            `;
            outfitBox.style.display = 'block';
          } else {
            outfitBox.innerHTML = `<div>Kh√¥ng c√≥ d·ªØ li·ªáu trang ph·ª•c cho ng√†y ${departure_date}</div>`;
            outfitBox.style.display = 'block';
          }
        }

        if (fr.ok) {
          const f = await fr.json();
          if (f && Array.isArray(f.days) && f.days.length) {
            const slidesHtml = f.days.map(renderForecastDay).join('');
            forecastBox.innerHTML = `
              <div class="forecast-header">
                <strong>D·ª± b√°o 5 ng√†y t·ªõi - ${f.city || ''}</strong>
                <div>
                  <button id="prevDay" class="nav-btn">&#8249;</button>
                  <button id="nextDay" class="nav-btn">&#8250;</button>
                </div>
              </div>
              <div id="slides">${slidesHtml}</div>
            `;
            forecastBox.style.display = 'block';
            const slides = Array.from(document.querySelectorAll('#slides .slide'));
            let index = 0;
            showSlide(index, slides);
            document.getElementById('prevDay').onclick = () => { index = Math.max(0, index - 1); showSlide(index, slides); };
            document.getElementById('nextDay').ondblclick = () => { index = Math.min(slides.length - 1, index + 1); showSlide(index, slides); };
            document.getElementById('nextDay').onclick = (e) => e.preventDefault();
          }
        }
        // Sightseeing (ƒë·ªãa ƒëi·ªÉm du l·ªãch, kh√¥ng chi ph√≠)
        try {
                const placeV = (placeInput.value || '').trim();
                let cityForAp = placeV|| 'H√† N·ªôi';
                if (cityForAp.toLowerCase() === 's√†i g√≤n' || cityForAp.toLowerCase() === 'saigon') {
                      cityForAp = 'H·ªì Ch√≠ Minh';
                }
          const sr = await fetch(`/sightseeing/no-cost-sightseeing?city=${encodeURIComponent(cityForAp)}`);
          if (sr.ok) {
            const ss = await sr.json();
            if (Array.isArray(ss) && ss.length) {
              const cards = ss.map(s => `
                <div class="cards-container">
                  <div class="s-title">${s.name || '-'}</div>
                  <div class="s-info">
                    <div>ƒê·ªãa ch·ªâ: ${s.address || '-'}</div>
                    ${s.open_close ? `<div>Gi·ªù m·ªü c·ª≠a: ${s.open_close}</div>` : ''}
                    ${s.type ? `<div>Lo·∫°i: ${s.type}</div>` : ''}
                    ${s.price ? `<div>Gi√° tham kh·∫£o: ${s.price}</div>` : ''}
                    ${s.describe ? `<div class="s-desc">${s.describe}</div>` : ''}
                  </div>
                </div>
              `).join('');
              sightseeingBox.innerHTML = `
                <div class='section-header'><strong>ƒê·ªãa ƒëi·ªÉm du l·ªãch g·ª£i √Ω</strong> - ${place}</div>
                <div class='sightseeing-grid'>${cards}</div>
              `;
              sightseeingBox.style.display = 'block';
            }
          }
        } catch {}
      } catch { }

      // Flights
      let url = `/flights/search-flights?origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&departure_date=${encodeURIComponent(departure_date)}&adults=${encodeURIComponent(adults)}`;

      // Th√™m th√¥ng tin kh√°ch s·∫°n v√† ng√¢n s√°ch n·∫øu c√≥
      if (hotelType) {
        url += `&hotel_type=${encodeURIComponent(hotelType)}`;
      }
      if (budget) {
        url += `&budget=${encodeURIComponent(budget)}`;
      }
      resultDiv.innerHTML = 'ƒêang t√¨m ki·∫øm...';
      try {
        const res = await fetch(url, { headers: { 'accept': 'application/json' } });
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || `HTTP ${res.status}`);
        }
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          resultDiv.innerHTML = 'Kh√¥ng t√¨m th·∫•y chuy·∫øn bay ph√π h·ª£p';
          return;
        }
        resultDiv.innerHTML = data.map((item, idx) => renderFlight(item, idx)).join('');
      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = 'C√≥ l·ªói x·∫£y ra khi t√¨m ki·∫øm';
      }
    });

    function renderFlight(item, index) {
      // Format gi√° VND v·ªõi d·∫•u ph·∫©y ph√¢n c√°ch h√†ng ngh√¨n
      const price = `${item.price.toLocaleString('vi-VN')} ${item.currency}`;

      // Hi·ªÉn th·ªã t·∫•t c·∫£ c√°c tuy·∫øn bay
      const segments = item.segments || [];
      let segmentsHtml = '';

      if (segments.length === 0) {
        segmentsHtml = '<div class="small">Kh√¥ng c√≥ th√¥ng tin tuy·∫øn bay</div>';
      } else if (segments.length === 1) {
        // Chuy·∫øn bay tr·ª±c ti·∫øp
        const seg = segments[0];
        segmentsHtml = `
          <div><strong>${seg.departure_iata}</strong> ‚Üí <strong>${seg.arrival_iata}</strong> | ${seg.carrier_code} ${seg.flight_number}</div>
          <div class="small">${seg.departure_time} ‚Üí ${seg.arrival_time} | Th·ªùi l∆∞·ª£ng: ${seg.duration}</div>
        `;
      } else {
        // Chuy·∫øn bay c√≥ chuy·ªÉn m√°y bay
        const firstSeg = segments[0];
        const lastSeg = segments[segments.length - 1];
        segmentsHtml = `
          <div><strong>${firstSeg.departure_iata}</strong> ‚Üí <strong>${lastSeg.arrival_iata}</strong> (${segments.length} tuy·∫øn - c√≥ chuy·ªÉn m√°y bay)</div>
        `;

        // Hi·ªÉn th·ªã chi ti·∫øt t·ª´ng tuy·∫øn
        segments.forEach((seg, index) => {
          segmentsHtml += `
            <div class="small">
              Tuy·∫øn ${index + 1}: <strong>${seg.departure_iata}</strong> ‚Üí <strong>${seg.arrival_iata}</strong> | ${seg.carrier_code} ${seg.flight_number}
              <br>&nbsp;&nbsp;&nbsp;&nbsp;${seg.departure_time} ‚Üí ${seg.arrival_time} | Th·ªùi l∆∞·ª£ng: ${seg.duration}
            </div>
          `;
        });
      }

      return `
        <div class="card" data-flight-index="${index}">
          ${segmentsHtml}
          <div>Gi√°: <strong>${price}</strong> | Gh·∫ø c√≤n: ${item.seats_left ?? '-'}</div>
          <div style="margin-top:8px;">
            <button class="show-hotels" data-index="${index}" data-price="${item.price}">Xem kh√°ch s·∫°n ph√π h·ª£p</button>
          </div>
          <div id="hotels-for-${index}" style="margin-top:10px;"></div>
        </div>
      `;
    }

    // Chuy·ªÉn gi√° tr·ªã ng√¢n s√°ch dropdown th√†nh kho·∫£ng ti·ªÅn [min, max]
    function getBudgetRange(budgetVal) {
      switch (budgetVal) {
        case 'under_2m': return [0, 2_000_000];
        case '2m_5m': return [2_000_000, 5_000_000];
        case '5m_10m': return [5_000_000, 10_000_000];
        case '10m_20m': return [10_000_000, 20_000_000];
        case '20m_50m': return [20_000_000, 50_000_000];
        case 'over_50m': return [50_000_000, Number.POSITIVE_INFINITY];
        default: return [0, Number.POSITIVE_INFINITY];
      }
    }

    // Parse gi√° kh√°ch s·∫°n t·ª´ price_point (c√≥ th·ªÉ l√† s·ªë ho·∫∑c chu·ªói)
    function parseHotelPrice(pricePoint) {
      if (pricePoint == null) return NaN;
      if (typeof pricePoint === 'number') return pricePoint;
      if (typeof pricePoint === 'string') {
        const digits = pricePoint.replace(/[^0-9]/g, '');
        if (!digits) return NaN;
        try { return parseInt(digits, 10); } catch { return NaN; }
      }
      return NaN;
    }

    // L·∫Øng nghe click ƒë·ªÉ hi·ªÉn th·ªã kh√°ch s·∫°n theo t·ª´ng chuy·∫øn bay v√† ng√¢n s√°ch c√≤n l·∫°i
    resultDiv.addEventListener('click', async (e) => {
      const btn = e.target.closest('.show-hotels');
      if (!btn) return;

      // L·∫•y d·ªØ li·ªáu c·∫ßn thi·∫øt
      const idx = btn.getAttribute('data-index');
      const flightPrice = parseInt(btn.getAttribute('data-price'), 10) || 0;
      const hotelsContainer = document.getElementById(`hotels-for-${idx}`);
      const hotelTypeVal = document.getElementById('hotelType').value || '';
      const budgetVal = document.getElementById('budget').value || '';
      const rooms = Math.max(1, parseInt((document.getElementById('rooms').value || '1'), 10));

      // L·∫•y city ti·∫øng Vi·ªát t·ª´ input ƒë·ªãa ƒëi·ªÉm
      const placeVal = (placeInput.value || '').trim();
      const cityForApi = placeVal || 'H√† N·ªôi';

      // Tr∆∞·ªùng h·ª£p KH√îNG nh·∫≠p ng√¢n s√°ch: hi·ªÉn th·ªã theo ƒë√°nh gi√°
      if (!budgetVal) {
        let selectedStars = NaN;
        if (hotelTypeVal) {
          selectedStars = parseInt(String(hotelTypeVal).replace(/\D/g, ''), 10);
        }
        let hotelApiUrl;
        if (!Number.isNaN(selectedStars)) {
          hotelApiUrl = `/hotel/top-hotel-star?city=${encodeURIComponent(cityForApi)}&stars=${encodeURIComponent(selectedStars)}`;
        } else {
          hotelApiUrl = `/hotel/top-hotel-rating?city=${encodeURIComponent(cityForApi)}`;
        }
        hotelsContainer.innerHTML = 'ƒêang t·∫£i d·ªØ li·ªáu kh√°ch s·∫°n...';
        try {
          const hotelResp = await fetch(hotelApiUrl);
          if (!hotelResp.ok) throw new Error('L·ªói khi l·∫•y d·ªØ li·ªáu kh√°ch s·∫°n');
          const hotels = await hotelResp.json();
          if (!hotels.length) {
            hotelsContainer.innerHTML = '<div class="small">Kh√¥ng c√≥ kh√°ch s·∫°n n√†o ph√π h·ª£p.</div>';
            return;
          }
          // S·∫Øp x·∫øp hi·ªÉn th·ªã theo ƒë√°nh gi√° (ph√≤ng tr∆∞·ªùng h·ª£p backend ch∆∞a sort)
          if (!Number.isNaN(selectedStars)) {
            hotels.sort((a, b) => (b.weighted_rating ?? b.rating ?? 0) - (a.weighted_rating ?? a.rating ?? 0));
          } else {
            hotels.sort((a, b) => (b.rating ?? b.weighted_rating ?? 0) - (a.rating ?? a.weighted_rating ?? 0));
          }
          hotelsContainer.innerHTML = hotels.map(h => {
             // X·ª≠ l√Ω utilities n·∫øu l√† m·∫£ng
            const utilitiesHtml = Array.isArray(h.utilities) && h.utilities.length > 0
            ? `<div class="hotel-utilities">
                ${h.utilities.map(u => `<span class="utility-tag">${u}</span>`).join(' ')}
              </div>`
            : '';

            const priceFormatted = Number.isFinite(parseHotelPrice(h.price_point))
            ? parseHotelPrice(h.price_point).toLocaleString('vi-VN') + ' VND'
            : '-';

            return `
              <div class="hotel-card">
                <div class="hotel-image-wrapper">
                  <a href="${h.link || '#'}" target="_blank" rel="noopener noreferrer" title="${h.name}">
                    <img src="${h.image || 'https://via.placeholder.com/300x180?text=No+Image'}" alt="${h.name}" class="hotel-image" />
                  </a>
                </div>
                <div class="hotel-info">
                  <h4><a href="${h.link || '#'}" target="_blank" rel="noopener noreferrer">${h.name}</a></h4>
                  <p class="hotel-address">${h.address || ''}</p>
                  <p class="hotel-stars">‚≠ê ${'‚òÖ'.repeat(h.stars || 0)}${'‚òÜ'.repeat(5 - (h.stars || 0))}</p>
                  <p>ƒêi·ªÉm ƒë√°nh gi√°: <strong>${h.rating ?? '-'}</strong> (${h.review_count ?? 0} ƒë√°nh gi√°)</p>
                  <p>Gi√° m·ªói ph√≤ng: <strong>${priceFormatted}</strong></p>
                </div>
              </div>
            `;
          }).join('');
        } catch (err) {
          console.error(err);
          hotelsContainer.innerHTML = '<div class="small">L·ªói khi t·∫£i d·ªØ li·ªáu kh√°ch s·∫°n</div>';
        }
        return;
      }

      const [budgetMin, budgetMax] = getBudgetRange(budgetVal);

      // Ng√¢n s√°ch t·ªïng cho c·∫£ chuy·∫øn ƒëi (kh√¥ng nh√¢n theo s·ªë ng∆∞·ªùi)
      const remainingBudget = (budgetMax || 0) - flightPrice;
      if (remainingBudget <= 0) {
        hotelsContainer.innerHTML = '<div class="small">Ng√¢n s√°ch kh√¥ng ƒë·ªß sau khi tr·ª´ ti·ªÅn v√© m√°y bay.</div>';
        return;
      }

      // Gi·ªõi h·∫°n t·ªëi ƒëa cho m·ªói ph√≤ng ƒë·ªÉ backend l·ªçc s∆° b·ªô
      const perRoomMax = Math.floor(remainingBudget / rooms);

      // X√°c ƒë·ªãnh endpoint theo vi·ªác c√≥ ch·ªçn lo·∫°i kh√°ch s·∫°n hay kh√¥ng
      let hotelApiUrl;
      let selectedStars = NaN;
      if (hotelTypeVal) {
        selectedStars = parseInt(String(hotelTypeVal).replace(/\D/g, ''), 10);
      }
      const priceParams = `&max_price=${encodeURIComponent(perRoomMax)}`;
      if (!Number.isNaN(selectedStars)) {
        hotelApiUrl = `/hotel/top-hotel-star?city=${encodeURIComponent(cityForApi)}&stars=${encodeURIComponent(selectedStars)}${priceParams}`;
      } else {
        hotelApiUrl = `/hotel/top-hotel-rating?city=${encodeURIComponent(cityForApi)}${priceParams}`;
      }

      hotelsContainer.innerHTML = 'ƒêang t·∫£i d·ªØ li·ªáu kh√°ch s·∫°n...';

      try {
        const hotelResp = await fetch(hotelApiUrl);
        if (!hotelResp.ok) throw new Error('L·ªói khi l·∫•y d·ªØ li·ªáu kh√°ch s·∫°n');
        const hotels = await hotelResp.json();

        // L·ªçc cu·ªëi c√πng theo t·ªïng chi ph√≠ kh√°ch s·∫°n = gi√° m·ªói ph√≤ng * s·ªë ph√≤ng <= remainingBudget
        const filtered = hotels.filter(h => {
          const hp = parseHotelPrice(h.price_point);
          if (!Number.isFinite(hp)) return false;
          return (hp * rooms) <= remainingBudget;
        });

        // S·∫Øp x·∫øp theo y√™u c·∫ßu
        if (!Number.isNaN(selectedStars)) {
          filtered.sort((a, b) => (b.weighted_rating ?? b.rating ?? 0) - (a.weighted_rating ?? a.rating ?? 0));
        } else {
          filtered.sort((a, b) => (b.rating ?? b.weighted_rating ?? 0) - (a.rating ?? a.weighted_rating ?? 0));
        }

        if (!filtered.length) {
          hotelsContainer.innerHTML = '<div class="small">Kh√¥ng c√≥ kh√°ch s·∫°n n√†o ph√π h·ª£p v·ªõi ng√¢n s√°ch c√≤n l·∫°i.</div>';
          return;
        }

                 // Render danh s√°ch kh√°ch s·∫°n
        hotelsContainer.innerHTML = filtered.map(h => {
           // X·ª≠ l√Ω utilities n·∫øu l√† m·∫£ng
          const utilitiesHtml = Array.isArray(h.utilities) && h.utilities.length > 0
          ? `<div class="hotel-utilities">
              ${h.utilities.map(u => `<span class="utility-tag">${u}</span>`).join(' ')}
            </div>`
          : '';

          const priceFormatted = Number.isFinite(parseHotelPrice(h.price_point))
          ? parseHotelPrice(h.price_point).toLocaleString('vi-VN') + ' VND'
          : '-';

          return `
            <div class="hotel-card">
              <div class="hotel-image-wrapper">
                <a href="${h.link || '#'}" target="_blank" rel="noopener noreferrer" title="${h.name}">
                  <img src="${h.image || 'https://via.placeholder.com/300x180?text=No+Image'}" alt="${h.name}" class="hotel-image" />
                </a>
              </div>
              <div class="hotel-info">
                <h4><a href="${h.link || '#'}" target="_blank" rel="noopener noreferrer">${h.name}</a></h4>
                <p class="hotel-address">${h.address || ''}</p>
                <p class="hotel-stars">‚≠ê ${'‚òÖ'.repeat(h.stars || 0)}${'‚òÜ'.repeat(5 - (h.stars || 0))}</p>
                <p>ƒêi·ªÉm ƒë√°nh gi√°: <strong>${h.rating ?? '-'}</strong> (${h.review_count ?? 0} ƒë√°nh gi√°)</p>
                <p>Gi√° m·ªói ph√≤ng: <strong>${priceFormatted}</strong></p>
                <p class="small">T·ªïng (∆∞·ªõc t√≠nh) cho ${rooms} ph√≤ng: <strong>${(() => { 
                  const p = parseHotelPrice(h.price_point);
                  return Number.isFinite(p) ? (p * rooms).toLocaleString('vi-VN') + ' VND' : '-'; 
                })()}</strong></p>
                ${utilitiesHtml}
                <button class="show-sightseeing" data-flight-price="${flightPrice}" data-hotel-price="${(() => { const p=parseHotelPrice(h.price_point); return Number.isFinite(p)? p*rooms : '';})()}">Xem ƒë·ªãa ƒëi·ªÉm gi·∫£i tr√≠ ph√π h·ª£p</button>
              </div>
            </div>
          `;
        }).join('');

         // L·∫Øng nghe click ƒë·ªÉ hi·ªÉn th·ªã ƒë·ªãa ƒëi·ªÉm du l·ªãch theo ng√¢n s√°ch c√≤n l·∫°i
         hotelsContainer.addEventListener('click', async (e) => {
           const btn = e.target.closest('.show-sightseeing');
           if (!btn) return;

           const flightPrice = parseInt(btn.getAttribute('data-flight-price'), 10) || 0;
           const hotelTotal = parseInt(btn.getAttribute('data-hotel-price'), 10) || 0;

           const budgetVal = document.getElementById('budget').value || '';
           if (!budgetVal) {
             sightseeingBox.innerHTML = '<div class="small">Vui l√≤ng ch·ªçn ng√¢n s√°ch tr∆∞·ªõc.</div>';
             sightseeingBox.style.display = 'block';
             return;
           }
           const [ , budgetMax ] = getBudgetRange(budgetVal);

           // City ti·∫øng Vi·ªát
           const placeVal = (placeInput.value || '').trim();
           const cityForApi = placeVal || 'H√† N·ªôi';

           // Ng√¢n s√°ch c√≤n l·∫°i sau v√© v√† kh√°ch s·∫°n
           const remaining = (budgetMax || 0) - flightPrice - hotelTotal;
           if (remaining <= 0) {
             sightseeingBox.innerHTML = '<div class="small">Ng√¢n s√°ch kh√¥ng ƒë·ªß sau khi tr·ª´ ti·ªÅn v√© m√°y bay v√† kh√°ch s·∫°n.</div>';
             sightseeingBox.style.display = 'block';
             return;
           }

           // T·∫£i danh s√°ch ƒë·ªãa ƒëi·ªÉm du l·ªãch v√† l·ªçc theo approximate_price <= remaining
           sightseeingBox.innerHTML = 'ƒêang t·∫£i ƒë·ªãa ƒëi·ªÉm du l·ªãch...';
           sightseeingBox.style.display = 'block';
           try {
              const placeV = (placeInput.value || '').trim();
              let cityForAp = placeV|| 'H√† N·ªôi';
              if (cityForAp.toLowerCase() === 's√†i g√≤n' || cityForAp.toLowerCase() === 'saigon') {
                    cityForAp = 'H·ªì Ch√≠ Minh';
              }
             const sr = await fetch(`/sightseeing/no-cost-sightseeing?city=${encodeURIComponent(cityForAp)}`);
             if (!sr.ok) throw new Error('Sightseeing fetch error');
             const ss = await sr.json();
             const filtered = (Array.isArray(ss) ? ss : []).filter(s => {
               if (typeof s.approximate_price === 'number') {
                 return s.approximate_price <= remaining;
               }
               // N·∫øu kh√¥ng c√≥ gi√° ∆∞·ªõc l∆∞·ª£ng, v·∫´n hi·ªÉn th·ªã nh∆∞ g·ª£i √Ω mi·ªÖn ph√≠/kh√¥ng r√µ gi√°
               return true;
             });

             if (!filtered.length) {
               sightseeingBox.innerHTML = '<div class="small">Kh√¥ng c√≥ ƒë·ªãa ƒëi·ªÉm gi·∫£i tr√≠ ph√π h·ª£p v·ªõi ng√¢n s√°ch c√≤n l·∫°i.</div>';
               return;
             }

             const cards = filtered.map(s => `
              <div class="cards-container">
                <div class="s-title">${s.name || '-'}</div>
                <div class="s-info">
                  <div>ƒê·ªãa ch·ªâ: ${s.address || '-'}</div>
                  ${s.open_close ? `<div>Gi·ªù m·ªü c·ª≠a: ${s.open_close}</div>` : ''}
                  ${s.type ? `<div>Lo·∫°i: ${s.type}</div>` : ''}
                  ${s.price ? `<div>Gi√° tham kh·∫£o: ${s.price}</div>` : ''}
                  ${s.describe ? `<div class="s-desc">${s.describe}</div>` : ''}
                </div>
              </div>
             `).join('');

             sightseeingBox.innerHTML = `
               <div class='section-header'>
                 <strong>ƒê·ªãa ƒëi·ªÉm du l·ªãch g·ª£i √Ω</strong> - ${cityForAp}
                 <div class='small'>Chi ph√≠ hi·ªán t·∫°i: ${flightPrice.toLocaleString('vi-VN')} VND (v√© m√°y bay) + ${hotelTotal.toLocaleString('vi-VN')} VND (kh√°ch s·∫°n)</div>
                 <div class='small'>Ng√¢n s√°ch c√≤n l·∫°i: ${remaining.toLocaleString('vi-VN')} VND</div>
               </div>
               <div class='sightseeing-grid'>${cards}</div>
             `;
           } catch (err) {
             console.error(err);
             sightseeingBox.innerHTML = '<div class="small">L·ªói khi t·∫£i ƒë·ªãa ƒëi·ªÉm du l·ªãch</div>';
           }
         });
      } catch (err) {
        console.error(err);
        hotelsContainer.innerHTML = '<div class="small">L·ªói khi t·∫£i d·ªØ li·ªáu kh√°ch s·∫°n</div>';
      }
    });
  </script>
</body>

</html>